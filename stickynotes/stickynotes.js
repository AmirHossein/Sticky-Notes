/**
 * Sticky Notes
 * Made for MODx Evolution 1.x
 * By Amir Hossein Hodjati Pour (AHHP) ~ Boplo.ir
 * Sep 2010
 * Version 1.0.1
 */ 
document.write('<div class="tab-page" id="stk-page" style="padding-left:0; padding-right:0"><h2 class="tab" id="stk-tab">Sticky Notes</h2> <script type="text/javascript">tpPane.addTabPage( document.getElementById( "stk-page" ) );</script> <script type="text/javascript" src="media/calendar/datepicker.js"></script><link rel="stylesheet" type="text/css" href="../assets/templates/manager/stickynotes/stickynotes.css" /><div class="stk-description"><p></p><div class="actionButtons"><a href="javascript:Sticky.form.show()"><img src="../assets/templates/manager/stickynotes/img/add.png" alt="add new" /> Add New Note</a></div></div><div class="stk-column"><div id="stk-main" class="stk-panel"><div class="sectionHeader"><span onclick="Panels.toggle(this)">Your Sticky Notes</span><div class="stk-actions"><span class="stk-count">(0)</span><span class="stk-icons" title="Refresh" onclick="Panels.refresh(this)"></span></div></div><div class="stk-panel-content"><div class="sectionBody"><ul></ul></div></div></div></div><div class="stk-column"><div id="stk-todo" class="stk-panel"><div class="sectionHeader"><span onclick="Panels.toggle(this)">ToDo list</span><div class="stk-actions"><span class="stk-count">(0)</span><span class="stk-icons" title="Refresh" onclick="Panels.refresh(this)"></span></div></div><div class="stk-panel-content"><div class="sectionBody"><ul></ul></div></div></div><div id="stk-finished" class="stk-panel"><div class="sectionHeader"><span onclick="Panels.toggle(this)">Finished Tasks</span><div class="stk-actions"><span class="stk-count">(0)</span><span class="stk-icons" title="Refresh" onclick="Panels.refresh(this)"></span></div></div><div class="stk-panel-content"><div class="sectionBody"><ul></ul></div></div></div><div id="stk-archive" class="stk-panel"><div class="sectionHeader"><span onclick="Panels.toggle(this)">Archive</span><div class="stk-actions"><span class="stk-count">(0)</span><span class="stk-icons" title="Refresh" onclick="Panels.refresh(this)"></span></div></div><div class="stk-panel-content"><div class="sectionBody"><ul></ul></div></div></div><div id="stk-trash" class="stk-panel"><div class="sectionHeader"><span onclick="Panels.toggle(this)">Trash can</span><div class="stk-actions"><span class="stk-count">(0)</span><span class="stk-icons" title="Refresh" onclick="Panels.refresh(this)"></span><span class="stk-icons" title="Empty Trash" onclick="Panels.emptyTrash()"></span></div></div><div class="stk-panel-content"><div class="sectionBody"><ul></ul></div></div></div></div><div style="clear:both; height:10px;"></div><div id="stk-footer"><a href="#" id="stk-help">I need help!</a><form style="display:inline;float:right" onsubmit="return false"><input type="text" id="stk-search" value="Search in Titles and Comments..." /></form><div class="clr"></div></div><form id="stk-form" onsubmit="return false;"><ul><li>Add / Modify Tasks</li><li><div style="width:70%">Title<input type="text" name="title" value="" /></div><div style="width:20%; margin-left:10%;">Progress %<input type="text" name="progress" value="" /></div></li><li>Comment<textarea name="comment"></textarea></li><li><div style="width:33%;margin-top:10px;margin-bottom:5px;"><input type="checkbox" name="finished" value="finished" /> Finished</div><div style="width:33%;margin-top:10px;margin-bottom:5px;"><input type="checkbox" name="archived" value="archived" /> Archive</div><div style="width:33%;margin-top:10px;margin-bottom:5px;"><input type="checkbox" name="restore" value="restore" /> Restore</div></li><li><div style="width:50%;clear both;margin-bottom:10px;"> Assign task to another user: <select id="to_user" name="to_user"></select></div><div style="width:50%;clear both;margin-bottom:10px;"> Must be finished on: <input id="must_be_finishedon" name="must_be_finishedon" class="DatePicker" style="padding:0 0 0 24px; width:80%;" value="" /></div></li><li><div style="float:right; clear:both;margin-top:10px;"><a href="javascript:Sticky.form.hide()">Cancel</a><button onclick="javascript:Sticky.form.submit()" name="submit">Save</button></div></li></ul><input type="hidden" name="note" value="" /><input type="hidden" name="stk_action" value="form" /></form></div>');

path='../assets/templates/manager/stickynotes/';Sticky={ajax:{url:path+'stickynotes.php?rand='+Math.random(),config:{method:'post',cache:false,onFailure:function(xhr){if(console){console.log(xhr.responseText);if(console.dir)console.dir(xhr);}}}},Cookies:{getMap:function(ns){var cookie=Cookie.get('stk-'+ns);return cookie?Json.evaluate(cookie):{};},setMap:function(ns,map){var value=Json.toString(map);Cookie.set('stk-'+ns,value);},get:function(ns,key){var cookie=this.getMap(ns);return cookie[key];},set:function(ns,key,value){var cookie=this.getMap(ns);cookie[key]=value;this.setMap(ns,cookie);}},form:{show:function(id){var tabPage=$('stk-page');this.ovrly=Sticky.overlay.show(tabPage);this.form=$('stk-form')
this.form.getElement('textarea').setHTML('');this.form.reset();this.form.getElement('input[name=note]').setProperty('value',id||null);this.form.setStyles({display:'block',opacity:0});this.form.setStyle('margin-top',(-1*this.form.getSize().size.y/2));this.form.effect('opacity',{duration:300}).start(1);if(id){$('to_user').setProperty('disabled','disabled').getParent().setStyle('display','none');var _form=this.form;var loader=Sticky.loader.show(this.form);new Ajax(Sticky.ajax.url,$extend(Sticky.ajax.config,{data:'stk_action=fillForm&stk_key='+id,onComplete:function(){Sticky.loader.hide(loader);var response=Json.evaluate(this.response.text);if(response.error==false){_form.getElements('input').each(function(field){var name=field.getProperty('name');if(!field.getProperty('type')||field.getProperty('type')=='text')
field.setProperty('value',response.row[name]);if(field.getProperty('type')=='checkbox'&&response.row[name]==1)
field.setProperty('checked','checked');if(name=='restore')
field.getParent().setStyle('display',(response.row.deleted==0?'none':'block'));});_form.getElement('textarea').setHTML(response.row.comment);if(response.row.to_user!=0)
_form.getElement('select').getElement('option[value='+response.row[name]+']').setProperty('selected','selected');}}})).request();}else{$('to_user').removeProperty('disabled').getParent().setStyle('display','block');this.form.getElement('[name=restore]').getParent().setStyle('display','none');}},hide:function(){Sticky.overlay.hide(this.ovrly);this.form.effect('opacity',{duration:300}).start(0);},submit:function(){var loader=Sticky.loader.show(this.form);new Ajax(Sticky.ajax.url,$extend(Sticky.ajax.config,{data:this.form.toQueryString(),onComplete:function(){Sticky.loader.hide(loader);var response=Json.evaluate(this.response.text);if(response.error==true){alert(response.result);}
if(response.error==false){Sticky.form.hide();response.panels.each(function(panel){Panels.refresh(panel);});}}})).request();}},loader:{show:function(parent){Sticky.overlay.show(parent,true);loader=new Element('div',{'class':'stk-loader',styles:{opacity:0}}).inject(parent);loader.effect('opacity',{duration:300}).start(.5);return loader;},hide:function(loader){var overlay=loader.getPrevious();Sticky.overlay.hide(overlay);loader.effect('opacity',{duration:300,onComplete:function(){this.element.remove();}}).start(0);return loader;}},overlay:{show:function(parent,loader){overlay=new Element('div',{'class':'stk-overlay',styles:{opacity:0}}).inject(parent);if(loader){overlay.setStyle('background-color','#FFF');var opacity=.7;}else{var opacity=.5;}
overlay.effect('opacity',{duration:300}).start(opacity);return overlay;},hide:function(overlay){overlay.effect('opacity',{duration:300,onComplete:function(){this.element.remove();}}).start(0);return overlay;}},move:{sendRequest:function(action,_note){var note=$('stk-note-'+_note);var panel=note.getParent().getParent().getParent().getParent();var loader=Sticky.loader.show(panel);var self=this;new Ajax(Sticky.ajax.url,$extend(Sticky.ajax.config,{data:'stk_action='+action+'&stk_key='+_note,onComplete:function(){Sticky.loader.hide(loader);var response=Json.evaluate(this.response.text);if(response.error==false)
self.move(response,note,panel);}})).request();},move:function(response,note,panel){var target=$(response.target);var newRow=response.row;var count=response.count;if(panel.getProperty('id')=='stk-trash'||(panel.getProperty('id')=='stk-archive'&&target.getProperty('id')!='stk-trash')){Panels.refresh(panel);return;}
var targetPosition=target.getPosition();var notePosition=note.getCoordinates();var cloned=note.clone().setStyles($extend(notePosition,{position:'absolute',opacity:.8,'z-index':9999,'background-color':'#FFF'})).inject(document.body);new Fx.Styles(cloned,{duration:500,onComplete:function(){new Element('ul').setHTML(newRow).getElement('li').inject(target.getElement('.sectionBody ul'));cloned.remove();Panels.refresh(panel);target.getElement('.stk-count').setHTML('('+count+')');}}).start({top:(targetPosition.y+40),left:(targetPosition.x+5)});},archive:function(note){this.sendRequest('archive',note);},finish:function(note){this.sendRequest('finish',note);},'delete':function(note){this.sendRequest('delete',note);}}};Panels={refresh:function(panel){var panel=$(panel);if(!panel.hasClass('stk-panel'))panel=panel.getParent().getParent().getParent();var loader=Sticky.loader.show(panel);new Ajax(Sticky.ajax.url,$extend(Sticky.ajax.config,{data:'stk_action=refresh&stk_key='+panel.getProperty('id').substr(4),onComplete:function(){Sticky.loader.hide(loader);var response=Json.evaluate(this.response.text);panel.getElement('.sectionBody ul').setHTML(response.result.content);panel.getElement('.stk-count').setHTML('('+response.result.count+')');}})).request();},loading:function(){this.getElement('.stk-count').effect('opacity',{onComplete:function(){this.element.setHTML('(<img src="'+path+'images/small-loading.png" alt="sticky notes small loading" />)');this.element.effect('opacity').start(1);}}).start(0);this.getElement('.sectionBody').effect('opacity',{onComplete:function(){this.element.setHTML('<img class="stk-panel-loading" src="'+path+'images/big-loading.png" alt="sticky notes small loading" />');this.element.effect('opacity').start(1);}}).start(0);},toggle:function(title){var panel=title.getParent().getParent();if(panel.getElement('.sectionBody').getStyle('margin-top').toInt()<0)
this.open(panel);else
this.close(panel);},open:function(panel,options){var content=panel.getElement('.sectionBody');new Fx.Styles(content,options||{}).start({'margin-top':0});Sticky.Cookies.set('panels',panel.getProperty('id'),'1');},close:function(panel,options){var content=panel.getElement('.sectionBody');var height=content.getSize().size.y*-1;new Fx.Styles(content,options||{}).start({'margin-top':height});Sticky.Cookies.set('panels',panel.getProperty('id'),'0');},expand:function(title){var content=title.getParent().getParent().getElement('.stk-content');var extra=content.getElement('.stk-extra');if(content.getStyle('height').toInt()==0){var height=extra.getSize().size.y+10;new Fx.Styles(content,{onStart:function(){this.element.setStyles({'border-right-width':'1px','border-left-width':'1px','border-bottom-width':'1px'});}}).start({'height':extra.getSize().size.y,'padding-top':5,'padding-bottom':5});}else{new Fx.Styles(content,{onComplete:function(){this.element.setStyles({'border-right-width':0,'border-left-width':0,'border-bottom-width':0});}}).start({'height':0,'padding-top':0,'padding-bottom':0});}},emptyTrash:function(){if(!confirm('Deleted notes will not be accessible after emptying trash. Are you sure?'))return;new Ajax(Sticky.ajax.url,$extend(Sticky.ajax.config,{data:'stk_action=emptyTrash',onComplete:function(){var response=Json.evaluate(this.response.text);if(response.error==false)
Panels.refresh('stk-trash');}})).request();}};window.addEvent('domready',function(){var tabPage=$('stk-page');$('stk-tab').addEvent('click',function(){if(tabPage.getStyle('display')=='none')
return;new Ajax(Sticky.ajax.url,$extend(Sticky.ajax.config,{data:'stk_action=managers',onComplete:function(){var response=Json.evaluate(this.response.text);if(response.error==false)
$('to_user').setHTML(response.result);}})).request();new DatePicker($('must_be_finishedon'),{'yearOffset':0,'format':'YYYY-MM-dd hh:mm:00'});$$('.stk-panel').each(function(panel){var id=panel.getProperty('id');var sectionBody=panel.getElement('.sectionBody');var sectionHeader=panel.getElement('.sectionHeader');if(Sticky.Cookies.get('panels',id)!='0'){Panels.refresh(panel);}});$('stk-help').addEvent('click',function(e){e.preventDefault();var overlay=Sticky.overlay.show(tabPage);var loader=Sticky.loader.show(overlay);new Ajax(Sticky.ajax.url,$extend(Sticky.ajax.config,{data:'stk_action=help',onComplete:function(){Sticky.loader.hide(loader);var help=new Element('div',{styles:{position:'fixed','z-index':9999,opacity:0,width:600,left:'50%','margin-left':'-300px',top:80}}).inject(document.body).setHTML(this.response.text);help.effect('opacity').start(0,1);help.getElement('#stk-help-panel .sectionHeader .stk-actions span[title=close]').addEvent('click',function(){help.effect('opacity',{onComplete:function(){this.element.remove();}}).start(1,0);Sticky.overlay.hide(overlay);});}})).request();});$('stk-search').addEvents({focus:function(){if(this.getValue()=='Search in Titles and Comments...')
this.setProperty('value','').addClass('focused');},blur:function(){if(this.getValue()=='')
this.setProperty('value','Search in Titles and Comments...').removeClass('focused');},keyup:function(e){var event=new Event(e);if(event.key=='enter'){var loader=Sticky.loader.show(tabPage);new Ajax(Sticky.ajax.url,$extend(Sticky.ajax.config,{data:'stk_action=search&stk_key='+this.getValue(),onComplete:function(){Sticky.loader.hide(loader);var response=Json.evaluate(this.response.text);if(response.error==false){tabPage.getElements('.stk-panel .stk-panel-content .sectionBody ul li').each(function(li){var method=response.result.indexOf(li.getProperty('id').substr(9))==-1?'removeClass':'addClass';li.getElement('.stk-header .stk-title')[method]('stk-highlight');});}}})).request();}}})});});